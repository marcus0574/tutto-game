<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tutto - Ultimate Master Edition 2026</title>
    <style>
        :root {
            --gold: #ffd700;
            --panel-bg: rgba(0, 0, 0, 0.94);
            --accent: #2196f3;
            --danger: #ff1744;
            --success: #4caf50;
        }

        body { 
            margin: 0; padding: 0;
            background: radial-gradient(circle at center, #2e7d32 0%, #1b5e20 60%, #051a06 100%); 
            color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            overflow: hidden; touch-action: none; user-select: none; 
        }

        canvas { display: block; }

        /* --- UI OVERLAYS --- */
        #modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }

        .modal-box {
            background: #1a1a1a; padding: 40px; border: 4px solid var(--gold);
            border-radius: 30px; text-align: center; min-width: 400px;
            box-shadow: 0 0 70px rgba(0,0,0,1);
        }

        #setup-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
        }

        .setup-box { 
            background: #1a1a1a; padding: 40px; border: 4px solid var(--gold); 
            border-radius: 35px; text-align: center; width: 450px; 
            box-shadow: 0 25px 60px rgba(0,0,0,0.6);
        }

        input, select { 
            padding: 14px; font-size: 17px; border-radius: 12px; border: 2px solid #333; 
            margin: 8px 0; width: 100%; background: #000; color: white; box-sizing: border-box; 
            outline: none; transition: border-color 0.3s;
        }

        input:focus { border-color: var(--gold); }

        #info-window {
            position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85); border: 3px solid var(--gold);
            padding: 12px 60px; border-radius: 60px; text-align: center; min-width: 380px; z-index: 500;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
        }

        #status-text { font-size: 32px; color: var(--gold); font-weight: 900; text-transform: uppercase; letter-spacing: 3px; }

        /* --- SIDEBAR RECHTS --- */
        #sidebar { 
            position: absolute; right: 0; top: 0; width: 320px; height: 100%; 
            background: var(--panel-bg); border-left: 5px solid var(--gold); 
            padding: 25px; box-sizing: border-box; display: flex; flex-direction: column; z-index: 600;
        }

        .player-card { 
            margin-bottom: 12px; padding: 16px; border-radius: 18px; 
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); 
            position: relative; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .player-card.active { 
            border: 2px solid var(--gold); background: rgba(255, 215, 0, 0.18); 
            transform: scale(1.03); box-shadow: 0 0 25px rgba(255, 215, 0, 0.25);
        }

        .last-round-badge { 
            position: absolute; top: -10px; right: -10px; background: var(--danger); 
            color: white; font-size: 10px; padding: 5px 12px; border-radius: 20px; 
            font-weight: 900; box-shadow: 0 3px 12px rgba(0,0,0,0.5); border: 1px solid white;
        }

        .score-val { font-size: 26px; color: var(--gold); font-weight: 900; margin-top: 5px; }

        #round-area { 
            background: rgba(0,0,0,0.6); border-radius: 30px; padding: 22px; 
            text-align: center; border: 1px solid #444; margin-top: auto; 
        }

        .dice-tray { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; min-height: 60px; }
        .mini-die-img { width: 36px; height: 36px; border-radius: 10px; box-shadow: 0 3px 6px rgba(0,0,0,0.5); }

        /* --- CONTROLS --- */
        .controls { position: absolute; bottom: 45px; left: 400px; display: flex; gap: 30px; z-index: 600; }
        
        button { 
            padding: 20px 40px; font-size: 22px; font-weight: 900; border: none; 
            border-radius: 18px; cursor: pointer; color: white; text-transform: uppercase; 
            transition: transform 0.1s, box-shadow 0.1s, background 0.3s;
        }

        #roll-btn { background: linear-gradient(#4a4ae6, #1e1e96); box-shadow: 0 7px 0 #121260; }
        #save-btn { background: linear-gradient(#e64a4a, #961e1e); box-shadow: 0 7px 0 #601212; }
        
        #sort-btn { 
            background: #2a2a2a; font-size: 14px; padding: 12px; margin-top: 15px; 
            width: 100%; border-radius: 12px; border: 1px solid #444; color: #ccc;
        }
        #sort-btn:hover { background: #333; color: white; }
        
        button:active { transform: translateY(5px); box-shadow: none; }
        button:disabled { background: #222 !important; color: #444 !important; cursor: not-allowed; box-shadow: none !important; transform: none !important; }

        #card-btn { 
            position: absolute; top: 415px; left: 48px; background: var(--gold); 
            color: #000; width: 160px; padding: 20px; border-radius: 18px; 
            font-weight: 900; border: none; box-shadow: 0 12px 30px rgba(0,0,0,0.6); 
            cursor: pointer; z-index: 600; transition: transform 0.2s;
        }
        #card-btn:hover { transform: scale(1.05); }

        .highscore-list { margin-top: 30px; text-align: left; font-size: 15px; border-top: 1px solid #333; padding-top: 20px; }
        .hs-entry { display: flex; justify-content: space-between; padding: 6px 0; color: #bbb; border-bottom: 1px solid #222; }
        .hs-entry:last-child { border: none; }
    </style>
</head>
<body>

<div id="modal-overlay">
    <div class="modal-box" id="modal-content">
        <h2 id="modal-title" style="color: var(--gold); font-size: 34px; margin-top: 0; letter-spacing: 1px;">Titel</h2>
        <p id="modal-text" style="font-size: 22px; line-height: 1.6; color: #ddd;">Nachricht...</p>
        <button class="modal-btn" style="background:var(--gold); color:black; width:100%; padding:20px; border-radius:15px; font-weight:900; border:none; cursor:pointer; font-size: 18px;" id="modal-ok">ALLES KLAR</button>
    </div>
</div>

<div id="setup-screen">
    <div class="setup-box">
        <h1 style="color:var(--gold); font-size: 52px; margin-bottom: 5px; letter-spacing: 6px; text-shadow: 0 5px 15px rgba(0,0,0,0.5);">TUTTO</h1>
        <p style="color: #666; margin-bottom: 30px; font-weight: bold; letter-spacing: 2px;">PREMIUM EDITION 2026</p>
        
        <div id="player-inputs">
            <input type="text" id="p1" value="Spieler 1" placeholder="Name Spieler 1">
            <input type="text" id="p2" value="Spieler 2" placeholder="Name Spieler 2">
            <input type="text" id="p3" placeholder="Name Spieler 3 (Optional)">
            <input type="text" id="p4" placeholder="Name Spieler 4 (Optional)">
        </div>

        <p style="color: #888; margin-top: 20px; margin-bottom: 8px; font-size: 14px; font-weight: bold;">ZIELPUNKTZAHL</p>
        <select id="win-limit">
            <option value="2000">2.000 Punkte</option>
            <option value="6000" selected>6.000 Punkte</option>
            <option value="10000">10.000 Punkte</option>
        </select>

        <button style="background: var(--gold); color: black; width: 100%; margin-top: 30px; font-weight: 900; height: 65px; border-radius: 18px; font-size: 24px;" onclick="startGame()">JETZT STARTEN</button>
        
        <div class="highscore-list" id="highscore-list">
            <b style="color:var(--gold); display: block; margin-bottom: 12px; font-size: 15px; letter-spacing: 1.5px;">BESTENLISTE (TOP 5)</b>
            <div id="hs-entries"></div>
        </div>
    </div>
</div>

<div id="info-window">
    <div id="status-text">Karte ziehen!</div>
</div>

<div id="sidebar">
    <h2 style="color: var(--gold); text-align: center; margin-top: 0; font-size: 22px; letter-spacing: 2px; margin-bottom: 20px;">SCOREBOARD</h2>
    <div id="player-list"></div>
    
    <button id="sort-btn" onclick="sortDiceOnTable()">WÜRFEL ANORDNEN</button>

    <div id="round-area">
        <div style="font-size: 11px; color: #aaa; letter-spacing: 1.5px; margin-bottom: 8px; font-weight: bold;">AKTUELLER WURF</div>
        <div id="round-points" style="font-size: 58px; color: var(--gold); font-weight: 900; text-shadow: 0 3px 10px rgba(0,0,0,0.3);">0</div>
        <div class="dice-tray" id="collected-dice"></div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<div class="controls">
    <button id="roll-btn" onclick="rollDice()" disabled>WÜRFELN</button>
    <button id="save-btn" onclick="savePoints()" disabled>SICHERN</button>
</div>

<button id="card-btn" onclick="handleCardClick()" style="display:none">KARTE ZIEHEN</button>

<script>
    /* --- INTERNE LOGIK --- */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let players = [], scores = [], currentPlayer = 0;
    let cardDeck = [], currentCard = null, roundScore = 0;
    let numDiceToRoll = 6, dice = [], isAnimating = false, cardX = -350;
    let collectedDiceValues = [], kleeblattTuttos = 0;
    let winScore = 6000, particles = [], lastRoundStartedBy = -1;

    /* --- BILDER & SOUNDS --- */
    const cardImages = {}, diceImages = {};
    const deckImg = new Image(); deckImg.src = 'assets/stapel.png';
    
    const rollSound = new Audio('assets/dice_roll.mp3');
    const cardSound = new Audio('assets/card-sounds-35956.mp3');
    const nieteSound = new Audio('assets/niete.mp3');
    const winSound = new Audio('assets/win.mp3');

    function preloadAssets() {
        const cardFiles = {
            'kleeblatt': 'assets/karte_kleeblatt.png', 'feuerwerk': 'assets/karte_feuerwerk.png',
            'stop': 'assets/karte_stop.png', 'strasse': 'assets/karte_strasse.png',
            'plusminus': 'assets/karte_plusminus.png', 'x2': 'assets/karte_x2.png',
            'bonus200': 'assets/karte_200.png', 'bonus300': 'assets/karte_300.png',
            'bonus400': 'assets/karte_400.png', 'bonus500': 'assets/karte_500.png',
            'bonus600': 'assets/karte_600.png'
        };
        for (let key in cardFiles) { 
            const img = new Image(); img.src = cardFiles[key]; cardImages[key] = img; 
        }
        for (let i = 1; i <= 6; i++) { 
            const img = new Image(); img.src = `assets/die_${i}.png`; diceImages[i] = img; 
        }
        updateHighscoreDisplay();
    }

    function updateHighscoreDisplay() {
        const hs = JSON.parse(localStorage.getItem('tutto_hs_2026_v2') || "[]");
        document.getElementById('hs-entries').innerHTML = hs.length > 0 ? 
            hs.map(e => `<div class="hs-entry"><span>${e.name}</span><b>${e.score} Pkt.</b></div>`).join("") : 
            "<div style='color:#444; font-size:12px; text-align:center;'>Noch keine Einträge</div>";
    }

    function saveToHighscore(name, score) {
        let hs = JSON.parse(localStorage.getItem('tutto_hs_2026_v2') || "[]");
        hs.push({name, score});
        hs.sort((a,b) => b.score - a.score);
        localStorage.setItem('tutto_hs_2026_v2', JSON.stringify(hs.slice(0, 5)));
    }

    function createParticles(x, y, color, count) {
        for (let i = 0; i < count; i++) {
            particles.push({
                x, y, vx: (Math.random() - 0.5) * 16,
                vy: (Math.random() - 0.5) * 16 - 6,
                size: Math.random() * 7 + 2,
                color, life: 1.0, rot: Math.random() * Math.PI
            });
        }
    }

    function showDialog(title, text, type, callback) {
        if(type === 'niete') nieteSound.play().catch(e=>{});
        if(type === 'win') winSound.play().catch(e=>{});
        
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-text').innerText = text;
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('modal-ok').onclick = () => {
            document.getElementById('modal-overlay').style.display = 'none';
            if(callback) callback();
        };
    }

    function sortDiceOnTable() {
        if(isAnimating || dice.length === 0) return;
        dice.sort((a,b) => a.val - b.val);
        const startX = 380;
        dice.forEach((d, i) => {
            d.x = startX + (i * 100);
            d.y = canvas.height / 2 - 50;
            d.rot = 0;
        });
    }

    function createDeck() {
        let deck = [];
        deck.push({ name: "KLEEBLATT", type: "kleeblatt", imgKey: "kleeblatt" });
        for(let i=0; i<5; i++) deck.push({ name: "FEUERWERK", type: "feuerwerk", imgKey: "feuerwerk" });
        for(let i=0; i<10; i++) deck.push({ name: "STOP", type: "stop", imgKey: "stop" });
        for(let i=0; i<5; i++) deck.push({ name: "STRASSE", type: "strasse", imgKey: "strasse" });
        for(let i=0; i<5; i++) deck.push({ name: "PLUS/MINUS", type: "plusminus", imgKey: "plusminus" });
        for(let i=0; i<5; i++) deck.push({ name: "x2 KARTE", type: "x2", imgKey: "x2" });
        [200, 300, 400, 500, 600].forEach(v => {
            for(let i=0; i<5; i++) deck.push({ name: "BONUS " + v, type: "bonus", value: v, imgKey: "bonus" + v });
        });
        return deck.sort(() => Math.random() - 0.5);
    }

    function startGame() {
        players = [];
        for(let i=1; i<=4; i++) {
            let n = document.getElementById('p'+i).value.trim();
            if(n) players.push(n);
        }
        if(players.length === 0) players = ["Gastspieler"];
        scores = players.map(() => 0);
        winScore = parseInt(document.getElementById('win-limit').value);
        cardDeck = createDeck();
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('card-btn').style.display = 'block';
        updateUI();
    }

    function handleCardClick() {
        if (isAnimating) return;
        if (!currentCard || numDiceToRoll === 0) drawCard();
    }

    function drawCard() {
        if (cardDeck.length === 0) cardDeck = createDeck();
        cardSound.currentTime = 0; cardSound.play().catch(e => {});
        cardX = -350;
        currentCard = cardDeck.pop();
        if (numDiceToRoll === 0) { numDiceToRoll = 6; collectedDiceValues = []; }
        document.getElementById('status-text').innerText = currentCard.name;
        
        if (currentCard.type === "stop") {
            document.getElementById('roll-btn').disabled = true;
            setTimeout(() => { 
                showDialog("STOP", "Runde beendet!", 'niete', () => { roundScore = 0; nextTurn(); });
            }, 800);
        } else {
            document.getElementById('roll-btn').disabled = false;
        }
        updateUI();
    }

    function rollDice() {
        if (isAnimating || !currentCard) return;
        isAnimating = true;
        rollSound.currentTime = 0; rollSound.play().catch(e => {});
        dice = [];
        for(let i=0; i<numDiceToRoll; i++) {
            let pos; let attempts = 0;
            do {
                pos = { 
                    val: Math.floor(Math.random()*6)+1, 
                    x: 350 + Math.random() * (canvas.width - 780), 
                    y: 130 + Math.random() * (canvas.height - 380), 
                    sel: false, rot: Math.random() * Math.PI * 2 
                };
                attempts++;
            } while (dice.some(d => Math.hypot(pos.x-d.x, pos.y-d.y) < 115) && attempts < 100);
            dice.push(pos);
        }
        setTimeout(() => { isAnimating = false; checkNiete(); updateUI(); }, 1200);
    }

    function checkNiete() {
        let counts = {};
        dice.forEach(d => counts[d.val] = (counts[d.val] || 0) + 1);
        let hasValid = false;
        if(currentCard.type === "strasse") {
            dice.forEach(d => { if(!collectedDiceValues.includes(d.val)) hasValid = true; });
        } else {
            for(let v in counts) { if(counts[v] >= 3 || v == 1 || v == 5) hasValid = true; }
        }

        if(!hasValid) {
            document.getElementById('status-text').innerText = "NIETE!";
            // 2,5 Sekunden Verzögerung vor dem Nieten-Dialog
            setTimeout(() => {
                if (currentCard.type === "feuerwerk") {
                    showDialog("FEUERWERK", "Punkte bleiben sicher!", 'info', () => finalizePoints(roundScore));
                } else {
                    showDialog("NIETE", "Deine Punkte verfallen!", 'niete', () => { roundScore = 0; nextTurn(); });
                }
            }, 2500);
        }
    }

    canvas.addEventListener('mousedown', (e) => {
        if(isAnimating || !currentCard) return;
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        dice.forEach(d => { if(!d.sel && mx > d.x && mx < d.x+90 && my > d.y && my < d.y+90) handleSelection(d); });
    });

    function handleSelection(d) {
        let val = d.val;
        let p = 0;
        if(currentCard.type === "strasse") {
            if(!collectedDiceValues.includes(val)) {
                d.sel = true; collectedDiceValues.push(val); numDiceToRoll--;
                if(collectedDiceValues.length === 6) p = 2000;
            }
        } else {
            let same = dice.filter(x => !x.sel && x.val === val);
            if(same.length >= 3) {
                let count = 0;
                dice.forEach(x => {
                    if(!x.sel && x.val === val && count < 3) {
                        x.sel = true; count++; numDiceToRoll--; collectedDiceValues.push(val);
                    }
                });
                p = (val === 1) ? 1000 : val * 100;
            } else if(val === 1 || val === 5) {
                d.sel = true; numDiceToRoll--; collectedDiceValues.push(val);
                p = (val === 1) ? 100 : 50;
            }
        }
        roundScore += p;
        if(numDiceToRoll === 0) {
            createParticles(canvas.width/2, canvas.height/2, "#ffd700", 70);
            document.getElementById('status-text').innerText = "TUTTO!";
            
            if (currentCard.type === "kleeblatt") {
                kleeblattTuttos++;
                if (kleeblattTuttos === 2) {
                    showDialog("GLÜCKS-SIEG!", "Zwei Tuttos hintereinander! Du hast SOFORT gewonnen!", 'win', () => location.reload());
                } else {
                    setTimeout(() => {
                        numDiceToRoll = 6; collectedDiceValues = []; 
                        showDialog("ERSTES TUTTO!", "Noch ein Tutto für den Sieg!", 'info', () => { rollDice(); });
                    }, 800);
                }
            } else if (currentCard.type === "feuerwerk") {
                setTimeout(() => { numDiceToRoll = 6; collectedDiceValues = []; rollDice(); }, 800);
            }
        }
        updateUI();
    }

    function savePoints() {
        let finalTurnScore = roundScore;
        if (numDiceToRoll === 0) {
            if (currentCard.type === "bonus") finalTurnScore += currentCard.value;
            if (currentCard.type === "x2") finalTurnScore *= 2;
        }
        finalizePoints(finalTurnScore);
    }

    function finalizePoints(amount) {
        // Plus/Minus Logik: 1000 für dich, -1000 für Highscorer
        if (currentCard && currentCard.type === "plusminus" && numDiceToRoll === 0) {
            amount = 1000;
            let highestScore = Math.max(...scores);
            if (highestScore > 0) {
                scores = scores.map((s, idx) => (idx !== currentPlayer && s === highestScore) ? Math.max(0, s - 1000) : s);
            }
        }
        scores[currentPlayer] += amount;
        if(scores[currentPlayer] >= winScore && lastRoundStartedBy === -1) {
            lastRoundStartedBy = currentPlayer;
            showDialog("LETZTE RUNDE!", "Ziel erreicht! Letzte Chance für alle anderen.", 'info', () => nextTurn());
        } else {
            nextTurn();
        }
    }

    function nextTurn() {
        currentPlayer = (currentPlayer + 1) % players.length;
        if(currentPlayer === lastRoundStartedBy) {
            let maxScore = Math.max(...scores);
            let winnerIdx = scores.indexOf(maxScore);
            saveToHighscore(players[winnerIdx], maxScore);
            showDialog("ENDE", `${players[winnerIdx]} ist der Champion!`, 'win', () => location.reload());
            return;
        }
        roundScore = 0; numDiceToRoll = 6; dice = []; currentCard = null;
        collectedDiceValues = []; kleeblattTuttos = 0;
        document.getElementById('status-text').innerText = "Karte ziehen!";
        updateUI();
    }

    function updateUI() {
        document.getElementById('player-list').innerHTML = players.map((name, i) => `
            <div class="player-card ${i === currentPlayer ? 'active' : ''}">
                ${lastRoundStartedBy !== -1 ? '<span class="last-round-badge">LETZTE RUNDE</span>' : ''}
                <div style="font-size: 14px; opacity: 0.7; font-weight: bold;">${name}</div>
                <div class="score-val">${scores[i]} <span style="font-size:12px; opacity:0.4">/ ${winScore}</span></div>
            </div>`).join("");
        document.getElementById('round-points').innerText = roundScore;
        document.getElementById('collected-dice').innerHTML = collectedDiceValues.map(v => `<img src="assets/die_${v}.png" class="mini-die-img">`).join("");
        
        const isMustTutto = currentCard && ["feuerwerk", "plusminus", "kleeblatt"].includes(currentCard.type);
        document.getElementById('save-btn').disabled = !currentCard || roundScore === 0 || (isMustTutto && numDiceToRoll > 0);
        
        // Kleeblatt-Regel: Karte ziehen Button bei Tutto ausblenden
        const isKleeblatt = currentCard && currentCard.type === "kleeblatt";
        document.getElementById('card-btn').style.display = (!currentCard || (numDiceToRoll === 0 && !isKleeblatt)) ? "block" : "none";
    }

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (deckImg.complete) ctx.drawImage(deckImg, 35, 150, 195, 275);
        if (currentCard) {
            if (cardX < 55) cardX += 25;
            const img = cardImages[currentCard.imgKey];
            if (img?.complete) {
                ctx.save(); ctx.shadowBlur = 30; ctx.shadowColor = "rgba(0,0,0,0.7)";
                ctx.drawImage(img, cardX, 150, 180, 260); ctx.restore();
            }
        }
        dice.forEach(d => {
            if(!d.sel) {
                let displayVal = isAnimating ? (Math.floor(Date.now() / 80) % 6 + 1) : d.val;
                const img = diceImages[displayVal];
                if (img?.complete) {
                    ctx.save(); ctx.translate(d.x + 45, d.y + 45);
                    ctx.rotate(isAnimating ? Date.now() * 0.01 + d.rot : d.rot);
                    ctx.shadowBlur = 15; ctx.drawImage(img, -45, -45, 90, 90); ctx.restore();
                }
            }
        });
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.vy += 0.28; p.life -= 0.015;
            ctx.save(); ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
            ctx.translate(p.x, p.y); ctx.rotate(p.rot + (1 - p.life) * 5);
            ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size); ctx.restore();
            if(p.life <= 0) particles.splice(i, 1);
        });
        requestAnimationFrame(render);
    }

    preloadAssets();
    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    canvas.width = window.innerWidth; canvas.height = window.innerHeight; render();
</script>
</body>
</html>
